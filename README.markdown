Run a file through this code to see where you have repeating chunks; maybe you can factor them out and make your code shinier! (Work in progress.)